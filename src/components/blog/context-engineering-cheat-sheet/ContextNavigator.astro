---
// Server-side Frontmatter (runs at build time)
import contextData from "./data/contextNavigator.json";
---

<div class="context-navigator mt-8 mb-8">
  <div class="max-w-7xl mx-auto px-5">
    <header class="text-center mb-10">
      <h1 class="text-4xl font-bold text-ctp-text mb-3">
        Context Engineering Navigator
      </h1>
      <p class="text-lg text-ctp-subtext1">
        Interactive guide to context engineering techniques for LLMs
      </p>
    </header>

    <div class="search-container mb-8 flex justify-center gap-2">
      <input
        type="text"
        class="search-input px-5 py-3 text-base border-2 border-ctp-surface0 bg-ctp-mantle text-ctp-text rounded-full w-full max-w-md focus:border-ctp-blue focus:outline-none transition-colors duration-200"
        placeholder="Search techniques, use cases, or keywords..."
      />
    </div>

    <div class="filter-buttons flex gap-3 flex-wrap justify-center mb-8">
      <button
        class="filter-btn active px-4 py-2 border-2 border-ctp-surface1 bg-ctp-surface0 text-ctp-text rounded-2xl cursor-pointer transition-all duration-300 font-medium hover:bg-ctp-surface1 hover:border-ctp-blue hover:text-ctp-text hover:-translate-y-0.5"
        data-filter="all"
      >
        All Categories
      </button>
      {
        contextData.categories.map((category) => (
          <button
            class="filter-btn px-4 py-2 border-2 border-ctp-surface1 bg-ctp-surface0 text-ctp-text rounded-2xl cursor-pointer transition-all duration-300 font-medium hover:bg-ctp-surface1 hover:border-ctp-blue hover:text-ctp-text hover:-translate-y-0.5"
            data-filter={category.id}
          >
            {category.title}
          </button>
        ))
      }
    </div>

    <div class="main-grid flex flex-col gap-10 mb-10" id="techniquesGrid">
      {
        contextData.categories.map((category) => {
          const color = "blue";
          return (
            <div
              class="main-category bg-ctp-base border border-ctp-surface0 rounded-2xl p-8 shadow-lg transition-all duration-300"
              data-category={category.id}
            >
              <div
                class={`main-category-title text-3xl font-extrabold mb-8 flex items-center justify-between text-ctp-text border-b-4 border-ctp-${color} pb-4`}
              >
                <div class="flex items-center gap-4">
                  <div class={`w-8 h-8 rounded-full bg-ctp-${color}`} />
                  {category.title}
                </div>
                <button
                  class="collapse-toggle-btn px-3 py-1 text-sm font-medium text-ctp-subtext1 hover:text-ctp-text border border-ctp-blue hover:border-ctp-blue rounded-lg transition-all duration-200 hover:bg-ctp-surface0"
                  data-category={category.id}
                >
                  Collapse All
                </button>
              </div>

              {category.subcategories.map((subcategory) => (
                <details
                  class={`sub-category bg-ctp-mantle rounded-xl p-6 mb-6 border-l-4 border-ctp-${color} transition-all duration-300 hover:-translate-y-1 hover:shadow-lg`}
                  data-subcategory={subcategory.id}
                  open
                >
                  <summary class="category-title text-xl font-bold mb-5 flex items-center gap-3 text-ctp-text cursor-pointer">
                    <div class={`w-5 h-5 rounded-full bg-ctp-${color}`} />
                    {subcategory.title}
                  </summary>

                  {subcategory.subsections.map((subsection) => (
                    <>
                      <div class="subsection-title text-lg font-semibold mt-5 mb-4 text-ctp-subtext1 border-l-3 border-ctp-overlay0 pl-3">
                        {subsection.title}
                      </div>
                      <div class="technique-list space-y-3">
                        {subsection.techniques.map((technique) => (
                          <div
                            class="technique p-3 rounded-lg bg-ctp-mantle border border-ctp-surface0 cursor-pointer transition-all duration-200 hover:bg-ctp-surface1 hover:border-ctp-blue hover:translate-x-1 hover:shadow-md"
                            data-technique={technique.id}
                          >
                            <div class="technique-name font-semibold text-ctp-blue mb-1">
                              {technique.name}
                            </div>
                            <div class="technique-description text-sm text-ctp-subtext1 leading-relaxed">
                              {technique.description}
                            </div>
                            {technique.useCases.map((uc) => (
                              <span
                                class={`use-case inline-block border border-ctp-${color} bg-transparent text-ctp-text px-2 py-1 rounded-xl text-xs mt-2 mr-2`}
                              >
                                {uc}
                              </span>
                            ))}
                          </div>
                        ))}
                      </div>
                    </>
                  ))}
                </details>
              ))}
            </div>
          );
        })
      }
    </div>
  </div>
</div>

<style>
  /* All your previous styles go here */
  .technique.selected {
    background-color: var(--ctp-surface1);
    border-color: var(--ctp-blue);
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(137, 180, 250, 0.2);
  }
  .detail-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1.25rem;
  }
  .detail-table th,
  .detail-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--ctp-surface0, #45475a);
  }
  .detail-table th {
    background-color: var(--ctp-mantle, #181825);
    font-weight: 600;
    color: var(--ctp-text, #cdd6f4);
    width: 25%;
  }
  .detail-table td {
    vertical-align: top;
    color: var(--ctp-subtext1, #bac2de);
  }
  .sub-category summary {
    list-style: none;
    position: relative;
  }
  .sub-category summary::-webkit-details-marker {
    display: none;
  }
  .sub-category summary::before {
    content: "â–¼";
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.875rem;
    color: var(--ctp-subtext1);
    transition: transform 0.2s ease;
  }
  .sub-category[open] summary::before {
    transform: translateY(-50%) rotate(180deg);
  }
  /* ... etc ... */
</style>

<script>
  // Client-side script (runs in the browser)
  import Fuse from "fuse.js";

  // The detailed descriptions for when a technique is clicked
  const techniqueDetails = {
    clear: {
      title: "CLEAR Framework",
      howItWorks:
        "Conciseness, Logic, Explicitness, Adaptability, Reflectiveness for robust prompt design",
      whenToUse: "Design for various use cases with self-evaluation built in",
      useCase: "Building robust prompt templates for production AI systems",
      sectionOfPaper: "4.1.1",
    },
    cot: {
      title: "Chain of Thought (CoT)",
      howItWorks:
        "Breaks complex problems into step-by-step reasoning. Key phrase: 'Let's think step by step'.",
      whenToUse: "Multi-step arithmetic, logical reasoning tasks",
      useCase: "Mathematical problem solving, debugging code logic",
      sectionOfPaper: "4.1.1",
    },
    // ... Add ALL other technique details here for the click-to-expand feature
  };

  let searchData = [];
  let fuse = null;

  function buildSearchIndex() {
    searchData = [];
    document.querySelectorAll(".technique").forEach((technique) => {
      const name = technique
        .querySelector(".technique-name")
        .textContent.trim();
      const description = technique
        .querySelector(".technique-description")
        .textContent.trim();
      const useCases = Array.from(technique.querySelectorAll(".use-case"))
        .map((el) => el.textContent.trim())
        .join(" ");
      searchData.push({ element: technique, name, description, useCases });
    });
  }

  function filterTechniques(searchTerm: string) {
    const allMainCategories = document.querySelectorAll(".main-category");
    const allSubCategories = document.querySelectorAll(".sub-category");
    const allTechniques = document.querySelectorAll(".technique");

    if (!searchTerm.trim()) {
      allTechniques.forEach((t) => {
        t.style.display = "block";
      });
      allSubCategories.forEach((sc) => {
        sc.style.display = "block";
      });
      allMainCategories.forEach((mc) => {
        mc.style.display = "block";
      });
      return;
    }

    const results = fuse.search(searchTerm);
    const matchedElements = new Set(
      results.map((result) => result.item.element)
    );

    allTechniques.forEach((technique) => {
      technique.style.display = matchedElements.has(technique)
        ? "block"
        : "none";
    });
    allSubCategories.forEach((subCategory) => {
      const hasVisible = subCategory.querySelector(
        '.technique:not([style*="display: none"])'
      );
      subCategory.style.display = hasVisible ? "block" : "none";
    });
    allMainCategories.forEach((mainCategory) => {
      const hasVisible = mainCategory.querySelector(
        '.sub-category:not([style*="display: none"])'
      );
      mainCategory.style.display = hasVisible ? "block" : "none";
    });
  }

  function showCategory(filterValue) {
    document.querySelector(".search-input").value = ""; // Clear search
    filterTechniques(""); // Reset search results
    document.querySelectorAll(".main-category").forEach((category) => {
      category.style.display =
        filterValue === "all" || category.dataset.category === filterValue
          ? "block"
          : "none";
    });
  }

  function showTechniqueDetails(techniqueId) {
    const targetElement = document.querySelector(
      `[data-technique="${techniqueId}"]`
    );
    const details = techniqueDetails[techniqueId];
    const isAlreadyOpen = targetElement.classList.contains("selected");

    document.querySelectorAll(".technique").forEach((t) => {
      t.classList.remove("selected");
      const existingDetails = t.querySelector(".technique-details");
      if (existingDetails) existingDetails.remove();
    });

    if (!isAlreadyOpen && targetElement && details) {
      targetElement.classList.add("selected");
      const detailsDiv = document.createElement("div");
      detailsDiv.className =
        "technique-details mt-4 p-4 bg-ctp-surface0 rounded-lg border-l-4 border-ctp-blue";
      detailsDiv.innerHTML = `
          <table class="detail-table"><tbody>
            <tr><th>How It Works</th><td>${details.howItWorks}</td></tr>
            <tr><th>When To Use</th><td>${details.whenToUse}</td></tr>
            <tr><th>Use Case</th><td>${details.useCase}</td></tr>
            <tr><th>Section of Paper</th><td>${details.sectionOfPaper}</td></tr>
          </tbody></table>`;
      targetElement.appendChild(detailsDiv);
    }
  }

  function updateToggleButtonText(mainCategory) {
    const toggleBtn = mainCategory.querySelector(".collapse-toggle-btn");
    const allSubCats = mainCategory.querySelectorAll(".sub-category");
    const openSubCats = mainCategory.querySelectorAll(".sub-category[open]");
    if (openSubCats.length === 0 && allSubCats.length > 0) {
      toggleBtn.textContent = "Expand All";
    } else {
      toggleBtn.textContent = "Collapse All";
    }
  }

  // --- Initialize after DOM is ready ---
  buildSearchIndex();
  fuse = new Fuse(searchData, {
    keys: ["name", "description", "useCases"],
    threshold: 0.4,
  });

  document
    .querySelector(".search-input")
    .addEventListener("input", (e) => filterTechniques(e.target.value));

  document.querySelectorAll(".filter-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      document
        .querySelectorAll(".filter-btn")
        .forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      showCategory(btn.dataset.filter);
    });
  });

  const grid = document.getElementById("techniquesGrid");
  grid.addEventListener("click", (e) => {
    const technique = e.target.closest(".technique");
    if (technique) {
      showTechniqueDetails(technique.dataset.technique);
      return;
    }

    const toggleBtn = e.target.closest(".collapse-toggle-btn");
    if (toggleBtn) {
      const mainCategory = toggleBtn.closest(".main-category");
      const shouldExpand = toggleBtn.textContent.trim() === "Expand All";
      mainCategory.querySelectorAll(".sub-category").forEach((sc) => {
        shouldExpand ? sc.setAttribute("open", "") : sc.removeAttribute("open");
      });
      updateToggleButtonText(mainCategory);
      return;
    }

    const summary = e.target.closest(".sub-category summary");
    if (summary) {
      setTimeout(() => {
        // Allow 'open' attribute to update
        updateToggleButtonText(summary.closest(".main-category"));
      }, 10);
    }
  });

  document.querySelectorAll(".main-category").forEach(updateToggleButtonText);
</script>
